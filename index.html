<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Text Extractor - Claude AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .api-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .usage-tracker {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .process-button {
            background: #10b981;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .process-button:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .process-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .clear-button {
            background: #ef4444;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .clear-button:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .preview-section {
            margin-bottom: 20px;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .preview-item {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: #f9fafb;
        }

        .preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .preview-item .filename {
            padding: 8px;
            font-size: 12px;
            color: #374151;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .progress-section {
            margin: 20px 0;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .results-header h2 {
            color: #333;
            font-size: 22px;
        }

        .export-button {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .export-button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .results-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .results-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }

        .results-table tbody tr:hover {
            background: #f9fafb;
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .image-name {
            font-weight: 600;
            color: #374151;
            word-break: break-word;
        }

        .extracted-text {
            color: #4b5563;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        .extracted-text::-webkit-scrollbar {
            width: 6px;
        }

        .extracted-text::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .extracted-text::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .extracted-text::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .no-text {
            color: #9ca3af;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .results-table {
                font-size: 13px;
            }

            .results-table th,
            .results-table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ Image Text Extractor</h1>
        <p class="subtitle">Upload multiple images to extract text using Claude AI</p>

        <div class="api-section">
            <h3 style="color: #333; margin-bottom: 15px;">üîë Claude API Configuration</h3>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="password" id="apiKeyInput" placeholder="Enter your Claude API key (sk-ant-...)" 
                    style="flex: 1; min-width: 300px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                <button class="upload-button" id="saveApiKey" style="margin: 0;">Save Key</button>
                <span id="apiStatus" style="font-size: 14px; font-weight: 600;"></span>
            </div>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                Get your API key from <a href="https://console.anthropic.com/" target="_blank" style="color: #667eea;">console.anthropic.com</a>
                ‚Ä¢ Your key is stored locally in your browser
            </p>
        </div>

        <div class="usage-tracker">
            <h3 style="color: #333; margin-bottom: 15px;">üìä Usage Tracker (This Session)</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                    <div style="font-size: 28px; font-weight: bold; color: #10b981;" id="totalProcessed">0</div>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">Images Processed</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                    <div style="font-size: 28px; font-weight: bold; color: #f59e0b;" id="totalCost">$0.00</div>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">Total Spent</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                    <div style="font-size: 28px; font-weight: bold; color: #3b82f6;" id="avgCostPerImage">$0.000</div>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">Avg Cost/Image</div>
                </div>
            </div>
            <button id="resetUsage" style="margin-top: 15px; padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; color: #374151; font-weight: 600;">
                Reset Tracker
            </button>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">üì§</div>
            <p style="margin-bottom: 15px; color: #666;">Drag and drop images here or click to browse</p>
            <label for="fileInput">
                <span class="upload-button">Choose Images</span>
            </label>
            <input type="file" id="fileInput" accept="image/*" multiple>
            <p style="margin-top: 15px; font-size: 12px; color: #999;">Supports: JPG, PNG, GIF, BMP, WEBP</p>
        </div>

        <div class="preview-section" id="previewSection" style="display: none;">
            <h3 style="color: #333; margin-bottom: 10px;">Selected Images (<span id="imageCount">0</span>)</h3>
            
            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 15px;" id="costEstimatorBox">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong style="color: #92400e;">üí∞ Estimated Cost:</strong>
                        <span id="estimatedCost" style="font-size: 18px; font-weight: bold; color: #92400e; margin-left: 10px;">$0.00</span>
                    </div>
                    <div style="font-size: 12px; color: #92400e;">
                        (~$0.004 per image average)
                    </div>
                </div>
            </div>

            <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; color: #333; font-weight: 600;">
                    <span>‚öôÔ∏è Batch Size Limit:</span>
                    <input type="number" id="batchLimit" value="50" min="1" max="500" 
                        style="width: 80px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                    <span style="font-size: 13px; color: #666; font-weight: normal;">images per batch</span>
                </label>
                <p style="margin-top: 8px; font-size: 12px; color: #666; margin-bottom: 0;">
                    Large batches will be split automatically to protect your budget
                </p>
            </div>
            
            <div class="preview-grid" id="previewGrid"></div>
            <div style="margin-top: 20px;">
                <button class="process-button" id="processButton">Extract Text from Images</button>
                <button class="clear-button" id="clearButton">Clear All</button>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <p class="progress-text" id="progressText">Processing images...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>Extracted Text Results</h2>
                <button class="export-button" id="exportButton">Export to CSV</button>
            </div>
            <table class="results-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Image Name</th>
                        <th style="width: 70%;">Extracted Text</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let extractedData = [];
        let apiKey = localStorage.getItem('claudeApiKey') || '';
        
        // Usage tracking (persists in browser)
        let usageStats = JSON.parse(localStorage.getItem('usageStats') || '{"totalProcessed": 0, "totalCost": 0}');

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const previewGrid = document.getElementById('previewGrid');
        const imageCount = document.getElementById('imageCount');
        const processButton = document.getElementById('processButton');
        const clearButton = document.getElementById('clearButton');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const resultsBody = document.getElementById('resultsBody');
        const exportButton = document.getElementById('exportButton');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKey = document.getElementById('saveApiKey');
        const apiStatus = document.getElementById('apiStatus');
        const estimatedCost = document.getElementById('estimatedCost');
        const costEstimatorBox = document.getElementById('costEstimatorBox');
        const batchLimit = document.getElementById('batchLimit');
        const totalProcessed = document.getElementById('totalProcessed');
        const totalCost = document.getElementById('totalCost');
        const avgCostPerImage = document.getElementById('avgCostPerImage');
        const resetUsage = document.getElementById('resetUsage');

        // Cost calculation constants (Claude Sonnet 4.5)
        const COST_PER_INPUT_TOKEN = 3 / 1000000;  // $3 per million tokens
        const COST_PER_OUTPUT_TOKEN = 15 / 1000000; // $15 per million tokens
        const AVG_TOKENS_PER_IMAGE = 1600; // Base tokens for image
        const AVG_PROMPT_TOKENS = 50; // Prompt tokens
        const AVG_RESPONSE_TOKENS = 250; // Average response tokens

        // Initialize
        updateUsageDisplay();
        
        if (apiKey) {
            apiKeyInput.value = apiKey;
            updateApiStatus(true, 'API key saved ‚úì');
        }

        // Save API key
        saveApiKey.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (!key) {
                updateApiStatus(false, 'Please enter an API key');
                return;
            }
            if (!key.startsWith('sk-ant-')) {
                updateApiStatus(false, 'Invalid API key format');
                return;
            }
            apiKey = key;
            localStorage.setItem('claudeApiKey', key);
            updateApiStatus(true, 'API key saved ‚úì');
        });

        function updateApiStatus(success, message) {
            apiStatus.textContent = message;
            apiStatus.style.color = success ? '#10b981' : '#ef4444';
        }

        // Calculate estimated cost
        function calculateEstimatedCost(numImages) {
            const inputCost = numImages * (AVG_TOKENS_PER_IMAGE + AVG_PROMPT_TOKENS) * COST_PER_INPUT_TOKEN;
            const outputCost = numImages * AVG_RESPONSE_TOKENS * COST_PER_OUTPUT_TOKEN;
            return inputCost + outputCost;
        }

        // Update usage display
        function updateUsageDisplay() {
            totalProcessed.textContent = usageStats.totalProcessed.toLocaleString();
            totalCost.textContent = '$' + usageStats.totalCost.toFixed(4);
            
            if (usageStats.totalProcessed > 0) {
                const avg = usageStats.totalCost / usageStats.totalProcessed;
                avgCostPerImage.textContent = '$' + avg.toFixed(4);
            } else {
                avgCostPerImage.textContent = '$0.000';
            }
        }

        // Reset usage tracker
        resetUsage.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset the usage tracker?')) {
                usageStats = { totalProcessed: 0, totalCost: 0 };
                localStorage.setItem('usageStats', JSON.stringify(usageStats));
                updateUsageDisplay();
            }
        });

        // Update estimated cost when files change
        function updateCostEstimate() {
            const cost = calculateEstimatedCost(selectedFiles.length);
            estimatedCost.textContent = '$' + cost.toFixed(4);
            
            // Warning for large batches
            const limit = parseInt(batchLimit.value);
            if (selectedFiles.length > limit) {
                costEstimatorBox.style.background = '#fee2e2';
                costEstimatorBox.style.borderColor = '#ef4444';
            } else {
                costEstimatorBox.style.background = '#fef3c7';
                costEstimatorBox.style.borderColor = '#f59e0b';
            }
        }

        // File input change handler
        fileInput.addEventListener('change', handleFiles);

        // Drag and drop handlers
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            addFiles(files);
        });

        function handleFiles(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            selectedFiles = [...selectedFiles, ...files];
            updatePreview();
            updateCostEstimate();
        }

        function updatePreview() {
            if (selectedFiles.length === 0) {
                previewSection.style.display = 'none';
                return;
            }

            previewSection.style.display = 'block';
            imageCount.textContent = selectedFiles.length;
            previewGrid.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="filename" title="${file.name}">${file.name}</div>
                        <button class="remove-btn" onclick="removeFile(${index})">√ó</button>
                    `;
                    previewGrid.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
            updateCostEstimate();
        }

        clearButton.addEventListener('click', () => {
            selectedFiles = [];
            extractedData = [];
            fileInput.value = '';
            updatePreview();
            updateCostEstimate();
            resultsSection.classList.remove('active');
            progressSection.classList.remove('active');
        });

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Get media type from file
        function getMediaType(file) {
            const type = file.type;
            if (type === 'image/jpeg' || type === 'image/jpg') return 'image/jpeg';
            if (type === 'image/png') return 'image/png';
            if (type === 'image/gif') return 'image/gif';
            if (type === 'image/webp') return 'image/webp';
            return 'image/jpeg'; // default
        }

        // Extract text using Claude API
        async function extractTextWithClaude(file) {
            const base64Image = await fileToBase64(file);
            const mediaType = getMediaType(file);

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-5-20250929',
                    max_tokens: 4096,
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'image',
                                source: {
                                    type: 'base64',
                                    media_type: mediaType,
                                    data: base64Image
                                }
                            },
                            {
                                type: 'text',
                                text: 'Please extract all text from this image. Provide only the extracted text, maintaining the original structure and formatting as much as possible. If there is no text in the image, respond with "No text found".'
                            }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            
            // Calculate actual cost from usage
            const inputTokens = data.usage.input_tokens;
            const outputTokens = data.usage.output_tokens;
            const cost = (inputTokens * COST_PER_INPUT_TOKEN) + (outputTokens * COST_PER_OUTPUT_TOKEN);
            
            return {
                text: data.content[0].text,
                cost: cost
            };
        }

        processButton.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                alert('Please select at least one image');
                return;
            }

            if (!apiKey) {
                alert('Please enter and save your Claude API key first');
                return;
            }

            const limit = parseInt(batchLimit.value);
            
            // Check batch limit and confirm if exceeded
            if (selectedFiles.length > limit) {
                const proceed = confirm(
                    `‚ö†Ô∏è You have ${selectedFiles.length} images selected, which exceeds your batch limit of ${limit}.\n\n` +
                    `Estimated cost: $${calculateEstimatedCost(selectedFiles.length).toFixed(4)}\n\n` +
                    `Do you want to process only the first ${limit} images?`
                );
                
                if (!proceed) {
                    return;
                }
                
                // Trim to batch limit
                selectedFiles = selectedFiles.slice(0, limit);
                updatePreview();
                updateCostEstimate();
            }

            // Final confirmation with cost
            const estimatedCostValue = calculateEstimatedCost(selectedFiles.length);
            const confirmProcess = confirm(
                `Ready to process ${selectedFiles.length} image(s)\n\n` +
                `Estimated cost: $${estimatedCostValue.toFixed(4)}\n\n` +
                `Continue?`
            );
            
            if (!confirmProcess) {
                return;
            }

            extractedData = [];
            resultsBody.innerHTML = '';
            resultsSection.classList.remove('active');
            progressSection.classList.add('active');
            processButton.disabled = true;

            let batchCost = 0;

            try {
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = Math.round(((i + 1) / selectedFiles.length) * 100);
                    
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                    progressText.textContent = `Processing ${i + 1} of ${selectedFiles.length}: ${file.name}`;

                    try {
                        const result = await extractTextWithClaude(file);
                        const extractedText = result.text.trim();
                        batchCost += result.cost;
                        
                        extractedData.push({
                            filename: file.name,
                            text: extractedText || '(No text detected)',
                            cost: result.cost
                        });

                        addResultRow(file.name, extractedText || '(No text detected)', result.cost);
                    } catch (error) {
                        console.error('Error processing', file.name, error);
                        const errorMsg = `(Error: ${error.message})`;
                        extractedData.push({
                            filename: file.name,
                            text: errorMsg,
                            cost: 0
                        });
                        addResultRow(file.name, errorMsg, 0);
                    }
                }

                // Update usage stats
                usageStats.totalProcessed += selectedFiles.length;
                usageStats.totalCost += batchCost;
                localStorage.setItem('usageStats', JSON.stringify(usageStats));
                updateUsageDisplay();

                progressText.textContent = `Complete! Actual cost: $${batchCost.toFixed(4)}`;
                setTimeout(() => {
                    progressSection.classList.remove('active');
                    resultsSection.classList.add('active');
                }, 1500);

            } catch (error) {
                console.error('Fatal error:', error);
                progressText.textContent = 'Error: ' + error.message;
                progressText.style.color = '#ef4444';
            } finally {
                processButton.disabled = false;
            }
        });

        function addResultRow(filename, text, cost) {
            const row = document.createElement('tr');
            const isNoText = text.startsWith('(No text') || text.startsWith('(Error');
            row.innerHTML = `
                <td>
                    <div class="image-name">${filename}</div>
                    <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Cost: $${cost.toFixed(5)}</div>
                </td>
                <td><div class="extracted-text ${isNoText ? 'no-text' : ''}">${text}</div></td>
            `;
            resultsBody.appendChild(row);
        }

        exportButton.addEventListener('click', () => {
            if (extractedData.length === 0) return;

            let csv = 'Image Name,Extracted Text,Cost\n';
            extractedData.forEach(item => {
                const filename = `"${item.filename.replace(/"/g, '""')}"`;
                const text = `"${item.text.replace(/"/g, '""').replace(/\n/g, ' ')}"`;
                const cost = item.cost ? item.cost.toFixed(5) : '0';
                csv += `${filename},${text},${cost}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `text-extraction-${Date.now()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
